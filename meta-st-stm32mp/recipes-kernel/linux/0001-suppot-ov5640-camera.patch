From 2acc5d10a0f1ea222c5db3e6901af480fbb78a7b Mon Sep 17 00:00:00 2001
From: Tao Tang <15642339119@163.com>
Date: Sun, 23 Jul 2023 21:01:15 +0800
Subject: [PATCH] suppot ov5640 camera

Signed-off-by: Tao Tang <15642339119@163.com>
---
 arch/arm/boot/dts/stm32mp157d-robot.dtsi | 51 ++++++++++++++++++++++++
 drivers/media/i2c/ov5640.c               |  3 +-
 2 files changed, 53 insertions(+), 1 deletion(-)

diff --git a/arch/arm/boot/dts/stm32mp157d-robot.dtsi b/arch/arm/boot/dts/stm32mp157d-robot.dtsi
index 3d87f8858..6b748e183 100644
--- a/arch/arm/boot/dts/stm32mp157d-robot.dtsi
+++ b/arch/arm/boot/dts/stm32mp157d-robot.dtsi
@@ -78,6 +78,14 @@ led-blue {
 		};
 	};
 
+	clocks {
+		clk_ext_camera: clk-ext-camera {
+			#clock-cells = <0>;
+			compatible = "fixed-clock";
+			clock-frequency = <24000000>;
+		};
+	};
+
     	v3v3: regulator-3p3v {
 		compatible = "regulator-fixed";
         	regulator-name = "v3v3";
@@ -270,6 +278,25 @@ pins {
     };
 };
 
+&dcmi {
+	status = "okay";
+	pinctrl-names = "default", "sleep";
+	pinctrl-0 = <&dcmi_pins_a>;
+	pinctrl-1 = <&dcmi_sleep_pins_a>;
+
+	port {
+		dcmi_0: endpoint {
+			remote-endpoint = <&ov5640_0>;
+			bus-type = <5>;
+			bus-width = <8>;
+			hsync-active = <0>;
+			vsync-active = <0>;
+			pclk-sample = <1>;
+			pclk-max-frequency = <77000000>;
+		};
+	};
+};
+
 &i2c5 {
 	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&i2c5_pins_a>;
@@ -309,6 +336,30 @@ con_usbotg_hs_ep: endpoint {
 
 		};
     	};
+
+	ov5640: camera@3c {
+		compatible = "ovti,ov5640";
+		reg = <0x3c>;
+		clocks = <&clk_ext_camera>;
+		clock-names = "xclk";
+		DOVDD-supply = <&v2v8>;
+		powerdown-gpios = <&gpioe 11 (GPIO_ACTIVE_HIGH | GPIO_PUSH_PULL)>;
+		reset-gpios = <&gpioe 1 (GPIO_ACTIVE_LOW | GPIO_PUSH_PULL)>;
+		rotation = <180>;
+		status = "okay";
+
+		port {
+			ov5640_0: endpoint {
+				remote-endpoint = <&dcmi_0>;
+				bus-width = <8>;
+				data-shift = <2>;
+				hsync-active = <0>;
+				vsync-active = <0>;
+				pclk-sample = <1>;
+				pclk-max-frequency = <77000000>;
+			};
+		};
+	};
 };
 
 &ipcc {
diff --git a/drivers/media/i2c/ov5640.c b/drivers/media/i2c/ov5640.c
index d7d36ad86..9e2ad9e7a 100644
--- a/drivers/media/i2c/ov5640.c
+++ b/drivers/media/i2c/ov5640.c
@@ -3079,6 +3079,7 @@ static int ov5640_probe(struct i2c_client *client)
 	u32 rotation;
 	int ret;
 
+	dev_info(dev, "ov5640_probe start\n");
 	sensor = devm_kzalloc(dev, sizeof(*sensor), GFP_KERNEL);
 	if (!sensor)
 		return -ENOMEM;
@@ -3198,7 +3199,7 @@ static int ov5640_probe(struct i2c_client *client)
 	ret = v4l2_async_register_subdev_sensor_common(&sensor->sd);
 	if (ret)
 		goto free_ctrls;
-
+	dev_info(dev, "ov5640_probe success\n");
 	return 0;
 
 free_ctrls:
