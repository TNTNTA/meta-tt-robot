From 6ca9a16598246e9f9acbf5220f641109d14236c7 Mon Sep 17 00:00:00 2001
From: Tao Tang <15642339119@163.com>
Date: Sun, 4 Jun 2023 10:56:32 +0800
Subject: [PATCH] uboot support usb flush

Signed-off-by: Tao Tang <15642339119@163.com>
---
 arch/arm/dts/stm32mp157d-robot.dts  |  25 +--
 arch/arm/dts/stm32mp157d-robot.dtsi | 265 ++++++++++++++++++++--------
 include/configs/stm32mp1.h          |   1 +
 3 files changed, 198 insertions(+), 93 deletions(-)

diff --git a/arch/arm/dts/stm32mp157d-robot.dts b/arch/arm/dts/stm32mp157d-robot.dts
index 91e687f6dc..063560d07b 100644
--- a/arch/arm/dts/stm32mp157d-robot.dts
+++ b/arch/arm/dts/stm32mp157d-robot.dts
@@ -12,38 +12,15 @@
 #include "stm32mp157d-robot.dtsi"
 
 / {
-	model = "STMicroelectronics STM32MP157D TT Robot board V2.2";
+	model = "STMicroelectronics STM32MP157D TT Robot Board";
 	compatible = "st,stm32mp157d-robot", "st,stm32mp157";
 
 	chosen {
 		stdout-path = "serial0:115200n8";
 	};
-
-	reserved-memory {
-		gpu_reserved: gpu@f6000000 {
-			reg = <0xf6000000 0x8000000>;
-			no-map;
-		};
-	};
-};
-
-&gpu {
-	contiguous-area = <&gpu_reserved>;
-	status = "okay";
 };
 
-&ltdc {
-	status = "okay";
 
-	port {
-		#address-cells = <1>;
-		#size-cells = <0>;
 
-		ltdc_ep0_out: endpoint@0 {
-			reg = <0>;
-			remote-endpoint = <&panel_in_rgb>;
-		};
-	};
-};
 
 
diff --git a/arch/arm/dts/stm32mp157d-robot.dtsi b/arch/arm/dts/stm32mp157d-robot.dtsi
index d89eb02cf2..8868fe8ec8 100644
--- a/arch/arm/dts/stm32mp157d-robot.dtsi
+++ b/arch/arm/dts/stm32mp157d-robot.dtsi
@@ -61,90 +61,153 @@
 			reg = <0x38000000 0x10000>;
 			no-map;
 		};
+
+		gpu_reserved: gpu@f6000000 {
+			reg = <0xf6000000 0x8000000>;
+			no-map;
+		};
 	};
 
 	aliases {
 		serial0 = &uart4;
 	};
 
-	usb_phy_tuning: usb-phy-tuning {
-		st,hs-dc-level = <2>;
-		st,fs-rftime-tuning;
-		st,hs-rftime-reduction;
-		st,hs-current-trim = <15>;
-		st,hs-impedance-trim = <1>;
-		st,squelch-level = <3>;
-		st,hs-rx-offset = <2>;
-		st,no-lsfs-sc;
+	led {
+		compatible = "gpio-leds";
+		led-blue {
+			label = "heartbeat";
+			gpios = <&gpioe 15 GPIO_ACTIVE_HIGH>;
+			linux,default-trigger = "heartbeat";
+			default-state = "on";
+			status = "okay";
+		};
+	};
+
+	vin: vin {
+		compatible = "regulator-fixed";
+		regulator-name = "vin";
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
+		regulator-always-on;
 	};
 
 	vddcore: regulator-vddcore {
-        compatible = "regulator-fixed";
+        	compatible = "regulator-fixed";
 		regulator-name = "vddcore";
-		regulator-min-microvolt = <1200000>;
+		regulator-min-microvolt = <1350000>;
 		regulator-max-microvolt = <1350000>;
 		regulator-always-on;
-        regulator-boot-on;
+        	regulator-boot-on;
 	};
 
-    v3v3: regulator-3p3v {
-        compatible = "regulator-fixed";
-        regulator-name = "v3v3";
-        regulator-min-microvolt = <3300000>;
-        regulator-max-microvolt = <3300000>;
-        regulator-always-on;
-        regulator-boot-on;
-    };
-
-    v1v8_audio: regulator-v1v8-audio {
-        compatible = "regulator-fixed";
-        regulator-name = "v1v8_audio";
-        regulator-min-microvolt = <1800000>;
-        regulator-max-microvolt = <1800000>;
-        regulator-always-on;
-        regulator-boot-on;
-    };
-
-    vdd: regulator-vdd {
-        compatible = "regulator-fixed";
-        regulator-name = "vdd";
-        regulator-min-microvolt = <3300000>;
-        regulator-max-microvolt = <3300000>;
-        regulator-always-on;
-        regulator-boot-on;
-    };
-
-    vdd_usb: regulator-vdd-usb {
-        compatible = "regulator-fixed";
-        regulator-name = "vdd_usb";
-        regulator-min-microvolt = <3300000>;
-        regulator-max-microvolt = <3300000>;
-        regulator-always-on;
-        regulator-boot-on;
-    };
+	vdd_ddr: regulator-vdd_ddr {
+        	compatible = "regulator-fixed";
+		regulator-name = "vdd_ddr";
+		regulator-min-microvolt = <1350000>;
+		regulator-max-microvolt = <1350000>;
+		regulator-always-on;
+        	regulator-boot-on;
+	};
 
-	vin: vin {
+	vdd: regulator-vdd {
 		compatible = "regulator-fixed";
-		regulator-name = "vin";
+		regulator-name = "vdd";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		regulator-always-on;
+		regulator-boot-on;
+	};
+
+	v3v3: regulator-3p3v {
+		compatible = "regulator-fixed";
+		regulator-name = "v3v3";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		regulator-always-on;
+		regulator-boot-on;
+	};
+
+	vdda: regulator-vdda {
+		compatible = "regulator-fixed";
+		regulator-name = "vdda";
+		regulator-min-microvolt = <2900000>;
+		regulator-max-microvolt = <2900000>;
+		regulator-always-on;
+		regulator-boot-on;
+	};
+
+	v2v8: regulator-v2v8 {
+		compatible = "regulator-fixed";
+		regulator-name = "v2v8";
+		regulator-min-microvolt = <2800000>;
+		regulator-max-microvolt = <2800000>;
+		regulator-always-on;
+		regulator-boot-on;
+	};
+
+	vtt_ddr: regulator-vtt_ddr {
+		compatible = "regulator-fixed";
+		regulator-name = "vtt_ddr";
+		regulator-min-microvolt = <750000>;
+		regulator-max-microvolt = <750000>;
+		regulator-always-on;
+		regulator-boot-on;
+	};
+
+
+	vdd_usb: regulator-vdd-usb {
+		compatible = "regulator-fixed";
+		regulator-name = "vdd_usb";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		regulator-always-on;
+		regulator-boot-on;
+	};
+
+	v1v8: regulator-v1v8 {
+		compatible = "regulator-fixed";
+		regulator-name = "v1v8";
+		regulator-min-microvolt = <1800000>;
+		regulator-max-microvolt = <1800000>;
+		regulator-always-on;
+		regulator-boot-on;
+	};
+
+	vbus_otg: regulator-vbus_otg {
+		compatible = "regulator-fixed";
+		regulator-name = "vbus_otg";
 		regulator-min-microvolt = <5000000>;
 		regulator-max-microvolt = <5000000>;
 		regulator-always-on;
+		regulator-boot-on;
 	};
 
-	panel_backlight: panel-backlight {
-		compatible = "gpio-backlight";
-		gpios = <&gpioe 15 GPIO_ACTIVE_HIGH>;
-		default-on;
-		status = "okay";
+	usb_phy_tuning: usb-phy-tuning {
+		st,hs-dc-level = <2>;
+		st,fs-rftime-tuning;
+		st,hs-rftime-reduction;
+		st,hs-current-trim = <15>;
+		st,hs-impedance-trim = <1>;
+		st,squelch-level = <3>;
+		st,hs-rx-offset = <2>;
+		st,no-lsfs-sc;
 	};
 
+	// panel_backlight: panel-backlight {
+	// 	compatible = "gpio-backlight";
+	// 	gpios = <&gpioe 15 GPIO_ACTIVE_HIGH>;
+	// 	default-on;
+	// 	status = "okay";
+	// };
+
 	panel_rgb: panel-rgb {
 		compatible = "simple-panel";
 		// pinctrl-names = "default", "sleep";
 		pinctrl-names = "default";
 		pinctrl-0 = <&ltdc_pins_b>; 
 		// pinctrl-1 = <&ltdc_pins_sleep_b>;
-		backlight = <&panel_backlight>;
+		power-supply = <&v3v3>;
+		// backlight = <&panel_backlight>;
 		status = "okay";
 
 		port {
@@ -156,6 +219,11 @@
 
 };
 
+&gpu {
+	contiguous-area = <&gpu_reserved>;
+	status = "okay";
+};
+
 &cpu0{
 	cpu-supply = <&vddcore>;
 };
@@ -223,7 +291,7 @@
 	pinctrl-1 = <&sdmmc1_b4_od_pins_a>;
 	pinctrl-2 = <&sdmmc1_b4_sleep_pins_a>;
 	st,neg-edge;
-    broken-cd;
+    	broken-cd;
 	bus-width = <4>;
 	vmmc-supply = <&v3v3>;
 	status = "okay";
@@ -269,28 +337,73 @@
 	status = "okay";
 };
 
+&pinctrl {
+	fusb302_pins_a: fusb302-0 {
+		pins {
+			pinmux = <STM32_PINMUX('D', 7, ANALOG)>;
+			bias-pull-up;
+		};
+	};
+};
+
+&i2c5 {
+	pinctrl-names = "default", "sleep";
+	pinctrl-0 = <&i2c5_pins_a>;
+	pinctrl-1 = <&i2c5_sleep_pins_a>;
+	i2c-scl-rising-time-ns = <100>;
+	i2c-scl-falling-time-ns = <7>;
+	status = "okay";
+	/delete-property/dmas;
+	/delete-property/dma-names;
+
+	stusb1600@28 {
+		compatible = "st,stusb1600";
+		reg = <0x28>;
+		interrupts = <7 IRQ_TYPE_EDGE_FALLING>;
+		interrupt-parent = <&gpiod>;
+		pinctrl-names = "default";
+		pinctrl-0 = <&fusb302_pins_a>;
+		status = "okay";
+		vdd-supply = <&vin>;
+
+		connector {
+			compatible = "usb-c-connector";
+			label = "USB-C";
+			power-role = "dual";
+			power-opmode = "default";
+
+			port {
+				con_usbotg_hs_ep: endpoint {
+					remote-endpoint = <&usbotg_hs_ep>;
+				};
+			};
+		};
+	};
+};
+
 &usbh_ehci {
 	phys = <&usbphyc_port0>;
 	status = "okay";
 };
 
-// &usbotg_hs {
-// 	phys = <&usbphyc_port1 0>;
-// 	phy-names = "usb2-phy";
-// 	usb-role-switch;
-// 	status = "okay";
-
-// 	port {
-// 		usbotg_hs_ep: endpoint {
-// 			remote-endpoint = <&con_usbotg_hs_ep>;
-// 		};
-// 	};
-// };
-
 &usbphyc {
 	status = "okay";
 };
 
+&usbotg_hs {
+	vbus-supply = <&vbus_otg>;
+	phys = <&usbphyc_port1 0>;
+	phy-names = "usb2-phy";
+	usb-role-switch;
+	status = "okay";
+
+	port {
+		usbotg_hs_ep: endpoint {
+			remote-endpoint = <&con_usbotg_hs_ep>;
+		};
+	};
+};
+
 &usbphyc_port0 {
 	phy-supply = <&vdd_usb>;
 };
@@ -316,4 +429,18 @@
 			reg = <0>;
 		};
 	};
+};
+
+&ltdc {
+	status = "okay";
+
+	port {
+		#address-cells = <1>;
+		#size-cells = <0>;
+
+		ltdc_ep0_out: endpoint@0 {
+			reg = <0>;
+			remote-endpoint = <&panel_in_rgb>;
+		};
+	};
 };
\ No newline at end of file
diff --git a/include/configs/stm32mp1.h b/include/configs/stm32mp1.h
index 302fd3513b..db214f0838 100644
--- a/include/configs/stm32mp1.h
+++ b/include/configs/stm32mp1.h
@@ -149,6 +149,7 @@
  * and the ramdisk at the end.
  */
 #define CONFIG_EXTRA_ENV_SETTINGS \
+ 	"ethaddr=00:04:9f:04:d2:35\0" \
 	"kernel_addr_r=0xc2000000\0" \
 	"fdt_addr_r=0xc4000000\0" \
 	"fdtoverlay_addr_r=0xc4100000\0" \
